!function(e){function n(e){e.type="event",e.instance=new EventSource(e._url),e.instance.successCount=0,e.instance.onmessage=e._settings.onMessage,e.instance.onopen=function(n){0===e.instance.successCount++&&e._settings.onOpen(n)},e.instance.onerror=function(n){event.target.readyState===EventSource.CLOSED&&e._settings.onError(event)};for(var n in e._settings.events)e.instance.addEventListener(n,e._settings.events[n],!1)}function t(e){e.type="ajax",e.instance={successCount:0,id:null,retry:3e3,data:"",event:""},s(e)}function s(n){if(n.instance){var t={"Last-Event-ID":n.instance.id};e.extend(t,n._settings.headers),e.ajax({url:n._url,method:"GET",headers:t,success:function(e,t,i){if(n.instance){0===n.instance.successCount++&&n._settings.onOpen();var a=e.split("\n");n.instance.data="";var r=0;for(var c in a){var o=a[c].indexOf(":"),u=[a[c].substr(0,o),a[c].substr(o+1)];switch(u[0]){case"":u[1]||1!==r++||(eventMessage={data:n.instance.data,lastEventId:n.instance.id,origin:"http://"+i.getResponseHeader("Host"),returnValue:!0},n.instance.event&&n._settings.events[n.instance.event]?n._settings.events[n.instance.event](eventMessage):n._settings.onMessage(eventMessage),n.instance.data="",n.instance.event="",r=0);break;case"retry":r=0,n.instance.retry=parseInt(u[1].trim());break;case"id":r=0,n.instance.id=u[1].trim();break;case"event":r=0,n.instance.event=u[1].trim();break;case"data":r=0,n.instance.data+=(""!==n.instance.data?"\n":"")+u[1].trim();break;default:r=0}}setTimeout(function(){s(n)},n.instance.retry)}},error:n._settings.onError})}}e.extend({SSE:function(s,i){var a={instance:null,type:null},r={onOpen:function(e){},onEnd:function(e){},onError:function(e){},onMessage:function(e){},options:{},headers:{},events:{}};return e.extend(r,i),a._url=s,a._settings=r,a._start=a.start,a.start=function(){return this.instance?!1:(!window.EventSource||this._settings.options.forceAjax||Object.keys(this._settings.headers).length>0?t(this):n(this),!0)},a.stop=function(){return this.instance?(!window.EventSource||this._settings.options.forceAjax||Object.keys(this._settings.headers).length>0||this.instance.close(),this._settings.onEnd(),this.instance=null,this.type=null,!0):!1},a}})}(jQuery);
